---
title: "Lecture 27"
subtitle: "Generalized Linear Models: simple logistic regression"
author: "Psych 10 C"
institute: "University of California, Irvine"
date: "06/03/2022"
output:
  xaringan::moon_reader:
    self_contained: true
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

```{r xaringan-extra, echo = FALSE}
xaringanExtra::use_tile_view()

xaringanExtra::use_fit_screen()

xaringanExtra::use_editable(expires = 1)

xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         #<<
  mute_unhighlighted_code = TRUE  #<<
)

htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```

```{r load-tidy, echo = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(flipbookr)

knitr::opts_chunk$set(fig.width = 6, message = FALSE, 
                      warning = FALSE, comment = "", 
                      cache = F)

covid <- read_csv(file = here::here("data/week-10/covid-example.csv"))

betas_null <- glm(formula = test ~ 1, 
                  data = covid, 
                  family = binomial)$coef

covid <- covid %>% 
  mutate("prediction_null" = exp(betas_null) / (1 + exp(betas_null)),
         "loglikelihood_null" = dbinom(x = test, size = 1,
                                       prob = prediction_null,
                                       log = TRUE))

# Number of participants
n_total <- nrow(covid)

# Model complexity
complexity <- 1 * log(n_total)

# Log-likelihood
fit <- -2 * sum(covid$loglikelihood_null)

# Bayesian Information Criterion for Null model
bic_null <- fit + complexity
```

## Null model

- Last class we went over the null model in a simple logistic regression 
setting.

--

- According to the model, the probability of testing positive on a "perfect" 
test is equal for all participants regardless of the population that they
belong to.

--

- The Null model is formalized as follows:

$$y_i \sim \text{Bernoulli}\left(\theta\right)$$

--

- Were $\theta$ can be found from the definition of the logarithm of the odds:

$$ln\left(\frac{\theta}{1-\theta}\right) = \beta_0$$

$$\implies \theta = \frac{e^{\beta_0}}{1+e^{\beta_0}}$$

---

## Null model

- Remember that once we get a value for $\beta_0$ using the **`glm()`** function
in R, $e^{\beta_0}$ will just be a number between $0$ and $\infty$.

--

- For example, for the covid data we found that the estimated value of $\beta_0$
denoted by $\hat{\beta_0}$ was equal to `r round(betas_null,2)` which means that
the probability is equal to:

$$\frac{e^{`r round(betas_null,2)`}}{1+e^{`r round(betas_null,2)`}} = 
\frac{`r round(exp(betas_null),2)`}{1+`r round(exp(betas_null),2)`} = 
`r round(exp(betas_null)/(1+exp(betas_null)),2)`$$

--

- In other words the model predicts that the probability of a positive case is 
equal to `r round(exp(betas_null)/(1+exp(betas_null)),2)`.

--

- If we think about this in terms of the total number of infected participants 
in the sample, the model predicts that we should see 
`r 80 * round(exp(betas_null)/(1+exp(betas_null)),2)` in the population.

- However, this means that we should see approximately 
`r 40 * round(exp(betas_null)/(1+exp(betas_null)),2)` in each group, which is 
less than the observed ones in non vaccinated population and more than the 
vaccinated population.

---

## Simple logistic regression model

- Now we need to introduce the simple logistic regression model.

--

- This will be similar to the simple linear regression model that we talked 
about before.

--

- The main assumption of the model is that the probability of testing positive 
for covid is different depending on the population that you belong to. 

--

- First we have to assign a numeric value to our population, and as before, the
population that we assign to the value $0$ will be consider as the base-line.

--

- We will denote the indicator for vaccination status as:

$$z_i =
  \begin{cases}
    0 & \quad \text{if vaccination status } = \text{ not vaccinated}\\
    1 & \quad \text{if vaccination status } = \text{ vaccinated}
  \end{cases}$$
  
--

```{r}
covid <- covid %>% 
  mutate("vaccinated_id" = case_when(status == "not_vaccinated" ~ 0,
                                     status == "vaccinated" ~ 1))
```

---

# Simple logistic regression model

- Now we have an indicator function $z_i$ that takes the value $0$ if the 
participant belongs to the not vaccinated group and it takes the value $1$ if 
the participant belongs to the vaccinated group.

--

- The simple logistic regression model assumes that the probability of 
testing positive for covid is a function of vaccination status.

--

- We can formalize the model as follows:

$$y_i \sim \text{Bernoulli}\left(\theta_i\right)$$

- where $\theta_i$ represents the probability of testing positive for the *i-th*
participant.

--

- This time the probability has an index $i$ because it will be different 
depending on whether the participant belongs to the not vaccinated or the 
vaccinated population.

---

## From log-odds to probabilities

- Now, remember that our linear function is defined on the logarithm of the 
odds as follows:

$$\ln\left(\frac{\theta_i}{1-\theta_i}\right) = \beta_0 + \beta_1z_i$$

--

- If we take the same steps as with the Null model, then we can define the 
probability that the *i-th* participant will test positive as;

$$\theta_i = \frac{e^{\beta_0 + \beta_1z_i}}{1+e^{\beta_0 + \beta_1z_i}}$$

--

- Notice that the only difference between this model and the Null, is that we 
now have an additional $\beta_1z_i$ in the exponent; this part of the equation
represents the difference between the baseline population (not vaccinated)
and the vaccinated participants.

---

## Simple logistic regression

- Now that we have specified the model, we can look at how the parameters can 
be interpreted.

--

- In this case, $\beta_0$ represents the logarithm of the odds for the base line
population, in our example not vaccinated participants.

--

- However, the log-odds are difficult to interpret so we can use a 
transformation. In this case, $e^{\beta_0}$ can be interpreted as how many times 
more probable it is to test positive rather than negative in the baseline 
population.

--

- The value of $\beta_0+\beta_1$ represents the logarithm of the odds ratio for
the vaccinated population.

--

- Again, it will be easier to interpret a transformation of this sum. In this 
case, $e^{\beta_0+\beta_1}$ represents how many times more probable it is to 
test positive rather than negative in the vaccinated population.

--

- The parameter $\beta_1$ can be interpreted as the change in the log-odds 
associated with being part of the vaccinated population.

---

## Odds ratio

- Again, interpretations in terms of log-odds are difficult to understand in the
context of an experiment. However, this time, interpreting the transformation 
of $\beta_1$ is not as easy because it involves the comparison between two 
"rates of change".

--

- The value of $e^{\beta_1}$ is also known as the odds ratio. In our example, 
it represents how more/less probable it is to test positive rather than 
negative on the vaccinated population, in comparison to how more/less probable 
it is to test positive than negative in the not vaccinated population.

--

  - If $0<e^{\beta_1}<1$ it means that it would be more likely to test positive 
  rather than negative for a participant that belongs to the not vaccinated 
  population. This will happen if $\beta_1<0$.

--

  - If $e^{\beta_1}=1$ it means that it is equally probable to test positive 
  rather than negative regardless of the population that the participant 
  belongs to. This will happen if $\beta_1 = 0$.

--

  - Finally, if $1<e^{\beta_1}$ it means that it is more probable for a 
  participant to test positive rather than negative if they belong to the 
  vaccinated population. This will happen if $1<\beta_1$.

---

## Probability of a positive test

- This model also allows us to define two probabilities of a positive test, 
one for each value of $z_i$.

--

- The probability of testing positive is equal to:

.pull-left[
Not vaccinated group

$$\theta_{\text{not vaccinated}} = \frac{e^{\beta_0}}{1+e^{\beta_0}}$$
]

.pull-right[
Vaccinated group

$$\theta_{\text{vaccinated}} = \frac{e^{\beta_0+\beta_1}}{1+e^{\beta_0+\beta_1}}$$
]

--


- If we take the ratio between this two values we can get the relative risk.
The relative risk represents how much more probable it is to test positive in 
the vaccinated population in comparison to the not vaccinated population.

--

- The relative risk can be expressed as:

$$RR = \frac{\theta_{\text{vaccinated}}}{\theta_{\text{not vaccinated}}} = \frac{\frac{e^{\beta_0+\beta_1}}{1+e^{\beta_0+\beta_1}}}{\frac{e^{\beta_0}}{1+e^{\beta_0}}}$$

---

## Obtaining the values of the parameters

- Now that we have the values that we might be interested in we can obtain our
estimates for $\beta_0$ and $\beta_1$ using the **`glm()`** function in R.

--

```{r}
betas_lr <- glm(formula = test ~ vaccinated_id, 
                data = covid, 
                family = "binomial")$coef
```

--

- The estimated value of $\beta_0$ was `r round(betas_lr[1],2)`, while the 
estimated value of $\beta_1$ was equal to `r round(betas_lr[2],2)`.

--

.pull-left[
Estimated probability of a positive test rather than a negative one for the not vaccinated 
population.

$$e^{\hat{\beta}_0} = e^{`r round(betas_lr[1],2)`} = `r round(exp(betas_lr[1]),2)`$$
we can also use:

$$\frac{1}{e^{\hat{\beta}_0}} = \frac{1}{e^{`r round(-betas_lr[1],2)`}} = `r round(exp(-betas_lr[1]),2)`$$
]

.pull-right[
Estimated probability of a positive test rather than a negative one for the vaccinated 
population.

$$e^{\hat{\beta}_0+\hat{\beta}_1} = e^{`r round(betas_lr[1]+betas_lr[2],2)`} = `r round(exp(betas_lr[1]+betas_lr[2]),2)`$$

we can also use:

$$\frac{1}{e^{\hat{\beta}_0+\hat{\beta}_1}} = \frac{1}{e^{`r round(betas_lr[1]+betas_lr[2],2)`}} = `r round(exp(-betas_lr[1]-betas_lr[2]),2)`$$

]

---

## Odds ratio, Relative Risk and Probability

- With the estimated values of $\beta_0$ and $\beta_1$ we can also compute 
and interpret the odds ratio, the relative risk and the probability of a 
positive test in each group:

--

Odds ratio:

$$\text{OR} = \frac{\frac{\theta_{\text{vaccinated}}}{1-\theta_{\text{vaccinated}}}}{\frac{\theta_{\text{not vaccinated}}}{1-\theta_{\text{not vaccinated}}}}=\cdots \text{algebra}\cdots = e^{\hat{\beta}_1} = e^{`r round(betas_lr[2],2)`} = `r round(exp(betas_lr[2]),2)`$$

we can also have:

$$\frac{1}{OR} = \frac{1}{e^{\hat{\beta}_1}} = \frac{1}{e^{`r round(betas_lr[2],2)`}} = `r round(exp(-betas_lr[2]),2)`$$

- This means that it is 6 times more probable to test positive rather than 
negative in the not vaccinated group in comparison to the vaccinated group. 

---

## Odds ratio, Relative Risk and Probability

- To get the probability of testing positive in each population we can use the 
following formulas:

--

- The probability of testing positive for the not vaccinated group is equal to:

$$\theta_{\text{not vaccinated}} = \frac{e^{\hat{\beta}_0}}{1+e^{\hat{\beta}_0}} = \frac{e^{`r round(betas_lr[1],2)`}}{1+e^{`r round(betas_lr[1],2)`}} = \frac{`r round(exp(betas_lr[1]),2)`}{1+`r round(exp(betas_lr[1]),2)`} = `r round(exp(betas_lr[1])/(1+exp(betas_lr[1])),2)`$$

--

- The probability of testing positive for the vaccinated group is equal to:

$$\theta_{\text{vaccinated}} = \frac{e^{\hat{\beta}_0+\hat{\beta}_1}}{1+e^{\hat{\beta}_0+\hat{\beta}_1}} = \frac{e^{`r round(betas_lr[1]+betas_lr[2],2)`}}{1+e^{`r round(betas_lr[1]+betas_lr[2],2)`}} = \frac{`r round(exp(betas_lr[1]+betas_lr[2]),2)`}{1+`r round(exp(betas_lr[1]+betas_lr[2]),2)`} = `r round(exp(betas_lr[1]+betas_lr[2])/(1+exp(betas_lr[1]+betas_lr[2])),3)`$$

--

- With those values we can also obtain the Relative Risk:

$$RR = \frac{\theta_{\text{vaccinated}}}{\theta_{\text{not vaccinated}}} = \frac{`r round(exp(betas_lr[1]+betas_lr[2])/(1+exp(betas_lr[1]+betas_lr[2])),2)`}{`r round(exp(betas_lr[1])/(1+exp(betas_lr[1])),2)`} = `r round((exp(betas_lr[1]+betas_lr[2])/(1+exp(betas_lr[1]+betas_lr[2])))/exp(betas_lr[1])/(1+exp(betas_lr[1])),2)`$$

---

## Odds ratio, Relative Risk and Probability

- It is easy to interpret values of the Relative Risk if they are higher than 
1, so we can take the inverse of the Relative Risk and compare the probability 
of the not vaccinated group to the vaccinated one.

--

$$RR = \frac{\theta_{\text{not vaccinated}}}{\theta_{\text{vaccinated}}} = \frac{`r round(exp(betas_lr[1])/(1+exp(betas_lr[1])),2)`}{`r round(exp(betas_lr[1]+betas_lr[2])/(1+exp(betas_lr[1]+betas_lr[2])),2)`} = `r round((exp(betas_lr[1])/(1+exp(betas_lr[1])))/exp(betas_lr[1]+betas_lr[2])/(1+exp(betas_lr[1]+betas_lr[2])),2)`$$

--

- This result suggests that the Risk of testing positive for covid is 4.5 times
higher in the not vaccinated group in comparison to the vaccinated group.

--

- Keep in mind that this result comes from the particular sample that we have 
and there will be error.

--

- Actually, the value I used to simulate the data is around 2, which is smaller 
than the current estimates (2.5 in people 18 or older).

--

- This highlights the importance of large samples in this kind of context. The 
more observations we have the more confident we can be in our results.

---

## Model predictions

- Now we can compare our two models, the Null which assumes that the probability
of testing positive on our "perfect" test is independent from vaccination status, 
and the simple logistic regression model, which assumes that the probability of
testing positive is different in each group.

--

- To add the prediction of our model $\hat{\theta}_i$ to the data we can use
the following code:

```{r}
covid <- covid %>% 
  mutate("prediction_lr" = 
           exp(betas_lr[1] + betas_lr[2] * vaccinated_id) /
           (1 + exp(betas_lr[1] + betas_lr[2] * vaccinated_id)))
```

--

- The code will just add the value `r round(exp(betas_lr[1])/(1+exp(betas_lr[1])),2)` to participants who are not vaccinated and the value `r round(exp(betas_lr[1]+betas_lr[2])/(1+exp(betas_lr[1]+betas_lr[2])),3)` to 
participants who are.

---

## Log-likelihood

- With the predictions of the model we can calculate the log-likelihood of 
each of our observations $ll(y_i)$$ using the following code:

```{r}
covid <- covid %>% 
  mutate("loglikelihood_lr" = dbinom(x = test,
                                     size = 1, 
                                     prob = prediction_lr,
                                     log = TRUE))
```

--

- Then we can get the model "fit" by adding all those numbers and multiplying 
the sum by $-2$:

```{r}
fit_lr <- -2 * sum(covid$loglikelihood_lr)
```

--

- Finally, we can get the BIC by adding the fit and the model complexity. 
Remember that this new model has 2 parameters $\beta_0$ and $\beta_1$.

```{r}
bic_lr <- fit_lr + 2 * log(n_total)
```

---

## Model comparison

- As we have done before we can use a table to compare our models:

--

| Model | Parameters | BIC |
|-------|:----------:|:---:|
| Null | 1 | `r round(bic_null,2)` |
| Vaccination Status | 2 | `r round(bic_lr,2)` | 

--

- The model that assumes that there is a different probability of a positive 
test depending of vaccination status is the one that better accounts for our 
observations according to the BIC. 

--

- We can also report the value of the Relative Risk of a positive test to our
results:

--

  - According to this model, the probability of testing positive is approximately
  4 times higher in the not vaccinated population in comparison to the vaccinated
  one.
  
---

class: inverse, center, middle

# That's all for this quarter

--

### *you still have to turn in your final project!*
